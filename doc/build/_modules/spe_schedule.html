

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spe_schedule &mdash; SPOCK 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/style.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/jupyter-sphinx.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> SPOCK
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/quick-ref.html">Quick reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/api.html">API</a></li>
</ul>
<p class="caption"><span class="caption-text">Quick start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/SPOCKLT/examples_spocklt.html">Long term  scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/SPOCKST/examples_spockst.html">Short term scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/SPOCKapp/examples_app.html">SPOCKApp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SPOCK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>spe_schedule</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spe_schedule</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">astroplan.utils</span> <span class="kn">import</span> <span class="n">time_grid_from_range</span><span class="p">,</span> <span class="n">stride_array</span>
<span class="kn">from</span> <span class="nn">astroplan.constraints</span> <span class="kn">import</span> <span class="n">AltitudeConstraint</span><span class="p">,</span> <span class="n">AirmassConstraint</span>
<span class="kn">from</span> <span class="nn">astroplan.target</span> <span class="kn">import</span> <span class="n">get_skycoord</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ObservingBlock&#39;</span><span class="p">,</span> <span class="s1">&#39;TransitionBlock&#39;</span><span class="p">,</span> <span class="s1">&#39;Schedule&#39;</span><span class="p">,</span> <span class="s1">&#39;Slot&#39;</span><span class="p">,</span> <span class="s1">&#39;Scheduler&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SequentialScheduler&#39;</span><span class="p">,</span> <span class="s1">&#39;PriorityScheduler&#39;</span><span class="p">,</span> <span class="s1">&#39;Transitioner&#39;</span><span class="p">,</span> <span class="s1">&#39;Scorer&#39;</span><span class="p">,</span><span class="s1">&#39;DateElsa&#39;</span><span class="p">,</span><span class="s1">&#39;SimpleScheduler&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="ObservingBlock"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.ObservingBlock">[docs]</a><span class="k">class</span> <span class="nc">ObservingBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An observation to be scheduled, consisting of a target and associated</span>
<span class="sd">    constraints on observations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@u</span><span class="o">.</span><span class="n">quantity_input</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">configuration</span><span class="o">=</span><span class="p">{},</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target : `~astroplan.FixedTarget`</span>
<span class="sd">            Target to observe</span>

<span class="sd">        duration : `~astropy.units.Quantity`</span>
<span class="sd">            exposure time</span>

<span class="sd">        priority : integer or float</span>
<span class="sd">            priority of this object in the target list. 1 is highest priority,</span>
<span class="sd">            no maximum</span>

<span class="sd">        configuration : dict</span>
<span class="sd">            Configuration metadata</span>

<span class="sd">        constraints : list of `~astroplan.constraints.Constraint` objects</span>
<span class="sd">            The constraints to apply to this particular observing block.  Note</span>
<span class="sd">            that constraints applicable to the entire list should go into the</span>
<span class="sd">            scheduler.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ObservingBlock.__repr__"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.ObservingBlock.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">orig_repr</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">orig_repr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;object at&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">, unscheduled) at&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> to </span><span class="si">{2}</span><span class="s1">) at&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orig_repr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;object at&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="ObservingBlock.constraints_scores"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.ObservingBlock.constraints_scores">[docs]</a>    <span class="k">def</span> <span class="nf">constraints_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># TODO: setup a way of caching or defining it as an attribute during scheduling</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">constraint</span><span class="p">:</span> <span class="n">constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                           <span class="n">times</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">}</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ObservingBlock.from_exposures"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.ObservingBlock.from_exposures">[docs]</a>    <span class="k">def</span> <span class="nf">from_exposures</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">time_per_exposure</span><span class="p">,</span>
                       <span class="n">number_exposures</span><span class="p">,</span> <span class="n">readout_time</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                       <span class="n">configuration</span><span class="o">=</span><span class="p">{},</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">number_exposures</span> <span class="o">*</span> <span class="p">(</span><span class="n">time_per_exposure</span> <span class="o">+</span> <span class="n">readout_time</span><span class="p">)</span>
        <span class="n">ob</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
        <span class="n">ob</span><span class="o">.</span><span class="n">time_per_exposure</span> <span class="o">=</span> <span class="n">time_per_exposure</span>
        <span class="n">ob</span><span class="o">.</span><span class="n">number_exposures</span> <span class="o">=</span> <span class="n">number_exposures</span>
        <span class="n">ob</span><span class="o">.</span><span class="n">readout_time</span> <span class="o">=</span> <span class="n">readout_time</span>
        <span class="k">return</span> <span class="n">ob</span></div></div>

<div class="viewcode-block" id="Scorer"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scorer">[docs]</a><span class="k">class</span> <span class="nc">Scorer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns scores and score arrays from the evaluation of constraints on</span>
<span class="sd">    observing blocks</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">global_constraints</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        blocks : list of `~astroplan.scheduling.ObservingBlock` objects</span>
<span class="sd">            list of blocks that need to be scored</span>
<span class="sd">        observer : `~astroplan.Observer`</span>
<span class="sd">            the observer</span>
<span class="sd">        schedule : `~astroplan.scheduling.Schedule`</span>
<span class="sd">            The schedule inside which the blocks should fit</span>
<span class="sd">        global_constraints : list of `~astroplan.Constraint` objects</span>
<span class="sd">            any ``Constraint`` that applies to all the blocks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">observer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">schedule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_constraints</span> <span class="o">=</span> <span class="n">global_constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">get_skycoord</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">target</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">])</span>

<div class="viewcode-block" id="Scorer.create_score_array"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scorer.create_score_array">[docs]</a>    <span class="k">def</span> <span class="nf">create_score_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_resolution</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this makes a score array over the entire schedule for all of the</span>
<span class="sd">        blocks and each `~astroplan.Constraint` in the .constraints of</span>
<span class="sd">        each block and in self.global_constraints.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time_resolution : `~astropy.units.Quantity`</span>
<span class="sd">            the time between each scored time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        score_array : `~numpy.ndarray`</span>
<span class="sd">            array with dimensions (# of blocks, schedule length/ ``time_resolution``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">end_time</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">time_grid_from_range</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">time_resolution</span><span class="p">)</span>
        <span class="n">score_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
            <span class="c1"># TODO: change the default constraints from None to []</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>

                    <span class="n">applied_score</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                               <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>

                    <span class="n">score_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">applied_score</span>
                    <span class="n">score_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">to_value</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_constraints</span><span class="p">:</span>
            <span class="n">score_array</span> <span class="o">*=</span> <span class="n">constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span>
                                      <span class="n">grid_times_targets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">score_array</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Scorer.from_start_end"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scorer.from_start_end">[docs]</a>    <span class="k">def</span> <span class="nf">from_start_end</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                       <span class="n">global_constraints</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for if you don&#39;t have a schedule/ aren&#39;t inside a scheduler</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dummy_schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">dummy_schedule</span><span class="p">,</span> <span class="n">global_constraints</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sc</span></div></div>

<div class="viewcode-block" id="TransitionBlock"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.TransitionBlock">[docs]</a><span class="k">class</span> <span class="nc">TransitionBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameterizes the &quot;dead time&quot;, e.g. between observations, while the</span>
<span class="sd">    telescope is slewing, instrument is reconfiguring, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        components : dict</span>
<span class="sd">            A dictionary mapping the reason for an observation&#39;s dead time to</span>
<span class="sd">            `~astropy.units.Quantity` objects with time units</span>

<span class="sd">        start_time : `~astropy.units.Quantity`</span>
<span class="sd">            Start time of observation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="n">components</span>

<div class="viewcode-block" id="TransitionBlock.__repr__"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.TransitionBlock.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">orig_repr</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">comp_info</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">orig_repr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;object at&#39;</span><span class="p">,</span> <span class="s1">&#39; (</span><span class="si">{0}</span><span class="s1">, unscheduled) at&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_info</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> to </span><span class="si">{2}</span><span class="s1">) at&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orig_repr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;object at&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TransitionBlock.end_time"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.TransitionBlock.end_time">[docs]</a>    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TransitionBlock.components"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.TransitionBlock.components">[docs]</a>    <span class="k">def</span> <span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span></div>

    <span class="nd">@components</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">duration</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@u</span><span class="o">.</span><span class="n">quantity_input</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
<div class="viewcode-block" id="TransitionBlock.from_duration"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.TransitionBlock.from_duration">[docs]</a>    <span class="k">def</span> <span class="nf">from_duration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="c1"># for testing how to put transitions between observations during</span>
        <span class="c1"># scheduling without considering the complexities of duration</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">TransitionBlock</span><span class="p">({</span><span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">tb</span></div></div>

<div class="viewcode-block" id="Schedule"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule">[docs]</a><span class="k">class</span> <span class="nc">Schedule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object that represents a schedule, consisting of a list of</span>
<span class="sd">    `~astroplan.scheduling.Slot` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># as currently written, there should be no consecutive unoccupied slots</span>
    <span class="c1"># this should change to allow for more flexibility (e.g. dark slots, grey slots)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        start_time : `~astropy.time.Time`</span>
<span class="sd">            The starting time of the schedule; the start of your</span>
<span class="sd">            observing window.</span>
<span class="sd">        end_time : `~astropy.time.Time`</span>
<span class="sd">           The ending time of the schedule; the end of your</span>
<span class="sd">           observing window</span>
<span class="sd">        constraints : sequence of `~astroplan.constraints.Constraint` s</span>
<span class="sd">           these are constraints that apply to the entire schedule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">Slot</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Schedule.__repr__"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Schedule containing &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observing_blocks</span><span class="p">))</span> <span class="o">+</span>
                <span class="s1">&#39; observing blocks between &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">iso</span><span class="p">))</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Schedule.observing_blocks"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.observing_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">observing_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">)]</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Schedule.scheduled_blocks"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.scheduled_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">scheduled_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span> <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="p">]</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Schedule.open_slots"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.open_slots">[docs]</a>    <span class="k">def</span> <span class="nf">open_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">occupied</span><span class="p">]</span></div>

<div class="viewcode-block" id="Schedule.to_table"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.to_table">[docs]</a>    <span class="k">def</span> <span class="nf">to_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_transitions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_unused</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: allow different coordinate types</span>
        <span class="n">target_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">durations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ra1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ra2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ra3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dec1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dec3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">):</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">target_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1">#ra.append(slot.block.target.ra.hms)</span>
                <span class="n">ra1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">ra2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
                <span class="n">ra3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
                <span class="n">dec1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
                <span class="n">dec2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
                <span class="n">dec3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
                <span class="c1">#dec.append(slot.block.target.dec)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">configuration</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">show_transitions</span> <span class="ow">and</span> <span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">target_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;TransitionBlock&#39;</span><span class="p">)</span>
                <span class="c1">#ra.append(&#39;&#39;)</span>
                <span class="n">ra1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ra2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ra3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1">#dec.append(&#39;&#39;)</span>
                <span class="n">dec1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dec2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dec3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">changes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;slew_time&#39;</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                    <span class="n">changes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;slew_time&#39;</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">slot</span><span class="o">.</span><span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">show_unused</span><span class="p">:</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">target_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Unused Time&#39;</span><span class="p">)</span>
                <span class="c1">#ra.append(&#39;&#39;)</span>
                <span class="c1">#dec.append(&#39;&#39;)</span>
                <span class="n">ra1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ra2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ra3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dec1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dec2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dec3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">Table</span><span class="p">([</span><span class="n">target_names</span><span class="p">,</span> <span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span><span class="n">ra1</span><span class="p">,</span> <span class="n">ra2</span><span class="p">,</span> <span class="n">ra3</span><span class="p">,</span> <span class="n">dec1</span><span class="p">,</span> <span class="n">dec2</span><span class="p">,</span> <span class="n">dec3</span><span class="p">,</span> <span class="n">config</span><span class="p">],</span>
                     <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;start time (UTC)&#39;</span><span class="p">,</span> <span class="s1">&#39;end time (UTC)&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;duration (minutes)&#39;</span><span class="p">,</span><span class="s1">&#39;ra (h)&#39;</span><span class="p">,</span><span class="s1">&#39;ra (m)&#39;</span><span class="p">,</span><span class="s1">&#39;ra (s)&#39;</span><span class="p">,</span><span class="s1">&#39;dec (d)&#39;</span><span class="p">,</span><span class="s1">&#39;dec (m)&#39;</span><span class="p">,</span><span class="s1">&#39;dec (s)&#39;</span><span class="p">,</span> <span class="s1">&#39;configuration&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Schedule.new_slots"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.new_slots">[docs]</a>    <span class="k">def</span> <span class="nf">new_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot_index</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create new slots by splitting a current slot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        slot_index : int</span>
<span class="sd">            The index of the slot to split</span>

<span class="sd">        start_time : `~astropy.time.Time`</span>
<span class="sd">            The start time for the slot to create</span>

<span class="sd">        end_time : `~astropy.time.Time`</span>
<span class="sd">            The end time for the slot to create</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_slots : list of `~astroplan.scheduling.Slot` s</span>
<span class="sd">            The new slots created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this is intended to be used such that there aren&#39;t consecutive unoccupied slots</span>
        <span class="n">new_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">split_slot</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_slots</span></div>

<div class="viewcode-block" id="Schedule.insert_slot"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.insert_slot">[docs]</a>    <span class="k">def</span> <span class="nf">insert_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a slot into schedule and associate a block to the new slot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_time : `~astropy.time.Time`</span>
<span class="sd">            The start time for the new slot.</span>
<span class="sd">        block : `~astroplan.scheduling.ObservingBlock`</span>
<span class="sd">            The observing block to insert into new slot.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slots : list of `~astroplan.scheduling.Slot` objects</span>
<span class="sd">            The new slots in the schedule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># due to float representation, this will change block start time</span>
        <span class="c1"># and duration by up to 1 second in order to fit in a slot</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">slot</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">start_time</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">start</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)):</span>
                <span class="n">slot_index</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;longer block than slot&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">&lt;</span> <span class="n">start_time</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
            <span class="c1"># slot duration is very similar to block duration.</span>
            <span class="c1"># force equality so block fits</span>
            <span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
            <span class="c1"># start time of block is very close to slot start time</span>
            <span class="c1"># force equality to avoid tiny gaps</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
            <span class="c1"># end time is very close to slot end time</span>
            <span class="c1"># force equality to avoid tiny gaps</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
            <span class="c1"># end time is very close to slot end time</span>
            <span class="c1"># force equality to avoid tiny gaps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="o">=</span><span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">=</span><span class="n">start_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
            <span class="c1"># TODO: make it shift observing/transition blocks to fill small amounts of open space</span>
            <span class="n">block</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">+</span><span class="n">block</span><span class="o">.</span><span class="n">duration</span>
        <span class="n">earlier_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[:</span><span class="n">slot_index</span><span class="p">]</span>
        <span class="n">later_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">block</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="n">new_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_slots</span><span class="p">(</span><span class="n">slot_index</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">new_slot</span> <span class="ow">in</span> <span class="n">new_slots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_slot</span><span class="o">.</span><span class="n">middle</span><span class="p">:</span>
                <span class="n">new_slot</span><span class="o">.</span><span class="n">occupied</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">new_slot</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slots</span> <span class="o">=</span> <span class="n">earlier_slots</span> <span class="o">+</span> <span class="n">new_slots</span> <span class="o">+</span> <span class="n">later_slots</span>
        <span class="k">return</span> <span class="n">earlier_slots</span> <span class="o">+</span> <span class="n">new_slots</span> <span class="o">+</span> <span class="n">later_slots</span></div>

<div class="viewcode-block" id="Schedule.change_slot_block"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Schedule.change_slot_block">[docs]</a>    <span class="k">def</span> <span class="nf">change_slot_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot_index</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the block associated with a slot.</span>

<span class="sd">        This is currently designed to work for TransitionBlocks in PriorityScheduler</span>
<span class="sd">        The assumption is that the slot afterwards is open and that the start time</span>
<span class="sd">        will remain the same.</span>

<span class="sd">        If the block is changed to None, the slot is merged with the slot</span>
<span class="sd">        afterwards to make a longer slot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        slot_index : int</span>
<span class="sd">            The slot to edit</span>
<span class="sd">        new_block : `~astroplan.scheduling.TransitionBlock`, default None</span>
<span class="sd">            The new transition block to insert in this slot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;slot afterwards is full&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">new_block</span><span class="o">.</span><span class="n">duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">new_end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">new_block</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">new_end</span>
            <span class="k">return</span> <span class="n">slot_index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span></div></div>

<div class="viewcode-block" id="Slot"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Slot">[docs]</a><span class="k">class</span> <span class="nc">Slot</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A time slot consisting of a start and end time</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        start_time : `~astropy.time.Time`</span>
<span class="sd">            The starting time of the slot</span>
<span class="sd">        end_time : `~astropy.time.Time`</span>
<span class="sd">            The ending time of the slot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Slot.duration"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Slot.duration">[docs]</a>    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span></div>

<div class="viewcode-block" id="Slot.split_slot"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Slot.split_slot">[docs]</a>    <span class="k">def</span> <span class="nf">split_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">early_time</span><span class="p">,</span> <span class="n">later_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split this slot and insert a new one.</span>

<span class="sd">        Will return the new slots created, which can either</span>
<span class="sd">        be one, two or three slots depending on if there is</span>
<span class="sd">        space remaining before or after the inserted slot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        early_time : `~astropy.time.Time`</span>
<span class="sd">            The start time of the new slot to insert.</span>
<span class="sd">        later_time : `~astropy.time.Time`</span>
<span class="sd">            The end time of the new slot to insert.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the new slot would overwrite occupied/other slots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupied</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;slot is already occupied&#39;</span><span class="p">)</span>

        <span class="n">new_slot</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">early_time</span><span class="p">,</span> <span class="n">later_time</span><span class="p">)</span>
        <span class="n">new_slot</span><span class="o">.</span><span class="n">middle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">early_slot</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">early_time</span><span class="p">)</span>
        <span class="n">late_slot</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">later_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">early_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">later_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">early_slot</span><span class="p">,</span> <span class="n">new_slot</span><span class="p">,</span> <span class="n">late_slot</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">early_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">early_slot</span><span class="p">,</span> <span class="n">new_slot</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">later_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">new_slot</span><span class="p">,</span> <span class="n">late_slot</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">new_slot</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Schedule a set of `~astroplan.scheduling.ObservingBlock` objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Scheduler.__metaclass__"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scheduler.__metaclass__">[docs]</a>    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span></div>

    <span class="nd">@u</span><span class="o">.</span><span class="n">quantity_input</span><span class="p">(</span><span class="n">gap_time</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">time_resolution</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">transitioner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gap_time</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">time_resolution</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : sequence of `~astroplan.constraints.Constraint`</span>
<span class="sd">            The constraints to apply to *every* observing block.  Note that</span>
<span class="sd">            constraints for specific blocks can go on each block individually.</span>
<span class="sd">        observer : `~astroplan.Observer`</span>
<span class="sd">            The observer/site to do the scheduling for.</span>
<span class="sd">        transitioner : `~astroplan.scheduling.Transitioner` (required)</span>
<span class="sd">            The object to use for computing transition times between blocks.</span>
<span class="sd">            Leaving it as ``None`` will cause an error.</span>
<span class="sd">        gap_time : `~astropy.units.Quantity` with time units</span>
<span class="sd">            The maximum length of time a transition between ObservingBlocks</span>
<span class="sd">            could take.</span>
<span class="sd">        time_resolution : `~astropy.units.Quantity` with time units</span>
<span class="sd">            The smallest factor of time used in scheduling, all Blocks scheduled</span>
<span class="sd">            will have a duration that is a multiple of it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">observer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span> <span class="o">=</span> <span class="n">transitioner</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">,</span> <span class="n">Transitioner</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A Transitioner is required&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_time</span> <span class="o">=</span> <span class="n">gap_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span> <span class="o">=</span> <span class="n">time_resolution</span>

<div class="viewcode-block" id="Scheduler.__call__"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scheduler.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">schedule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a set of `~astroplan.scheduling.ObservingBlock` objects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        blocks : list of `~astroplan.scheduling.ObservingBlock` objects</span>
<span class="sd">            The observing blocks to schedule.  Note that the input</span>
<span class="sd">            `~astroplan.scheduling.ObservingBlock` objects will *not* be</span>
<span class="sd">            modified - new ones will be created and returned.</span>
<span class="sd">        schedule : `~astroplan.scheduling.Schedule` object</span>
<span class="sd">            A schedule that the blocks will be scheduled in. At this time</span>
<span class="sd">            the ``schedule`` must be empty, only defined by a start and</span>
<span class="sd">            end time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        schedule : `~astroplan.scheduling.Schedule`</span>
<span class="sd">            A schedule objects which consists of `~astroplan.scheduling.Slot`</span>
<span class="sd">            objects with and without populated ``block`` objects containing either</span>
<span class="sd">            `~astroplan.scheduling.TransitionBlock` or `~astroplan.scheduling.ObservingBlock`</span>
<span class="sd">            objects with populated ``start_time`` and ``end_time`` or ``duration`` attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">schedule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span>
        <span class="c1"># these are *shallow* copies</span>
        <span class="n">copied_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">]</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_schedule</span><span class="p">(</span><span class="n">copied_blocks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">schedule</span></div>

    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="Scheduler._make_schedule"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scheduler._make_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">_make_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does the actual business of scheduling. The ``blocks`` passed in should</span>
<span class="sd">        have their ``start_time` and `end_time`` modified to reflect the</span>
<span class="sd">        schedule. Any necessary `~astroplan.scheduling.TransitionBlock` should</span>
<span class="sd">        also be added.  Then the full set of blocks should be returned as a list</span>
<span class="sd">        of blocks, along with a boolean indicating whether or not they have been</span>
<span class="sd">        put in order already.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        blocks : list of `~astroplan.scheduling.ObservingBlock` objects</span>
<span class="sd">            Can be modified as it is already copied by ``__call__``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        schedule : `~astroplan.scheduling.Schedule`</span>
<span class="sd">            A schedule objects which consists of `~astroplan.scheduling.Slot`</span>
<span class="sd">            objects with and without populated ``block`` objects containing either</span>
<span class="sd">            `~astroplan.scheduling.TransitionBlock` or `~astroplan.scheduling.ObservingBlock`</span>
<span class="sd">            objects with populated ``start_time`` and ``end_time`` or ``duration`` attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">return</span> <span class="n">schedule</span></div>


    <span class="nd">@classmethod</span>
    <span class="nd">@u</span><span class="o">.</span><span class="n">quantity_input</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
<div class="viewcode-block" id="Scheduler.from_timespan"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Scheduler.from_timespan">[docs]</a>    <span class="k">def</span> <span class="nf">from_timespan</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">center_time</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new instance of this class given a center time and duration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        center_time : `~astropy.time.Time`</span>
<span class="sd">            Mid-point of time-span to schedule.</span>

<span class="sd">        duration : `~astropy.units.Quantity` or `~astropy.time.TimeDelta`</span>
<span class="sd">            Duration of time-span to schedule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">center_time</span> <span class="o">-</span> <span class="n">duration</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">center_time</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SequentialScheduler"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.SequentialScheduler">[docs]</a><span class="k">class</span> <span class="nc">SequentialScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A scheduler that does &quot;stupid simple sequential scheduling&quot;.  That is, it</span>
<span class="sd">    simply looks at all the blocks, picks the best one, schedules it, and then</span>
<span class="sd">    moves on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SequentialScheduler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SequentialScheduler._make_schedule"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.SequentialScheduler._make_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">_make_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">block</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_time</span><span class="p">]</span> <span class="k">for</span>
                               <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">scheduled_blocks</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_filled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_time</span>
            <span class="n">filled_times</span> <span class="o">=</span> <span class="n">Time</span><span class="p">([</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                 <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">])</span>
            <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">filled_times</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filled_times</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">pre_filled</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">filled_times</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filled_times</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span>
            <span class="c1"># to make sure the scheduler has some constraint to work off of</span>
            <span class="c1"># and to prevent scheduling of targets below the horizon</span>
            <span class="c1"># TODO : change default constraints to [] and switch to append</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">AltitudeConstraint</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span><span class="p">):</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">b</span><span class="o">.</span><span class="n">_duration_offsets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                              <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">])</span>
            <span class="n">b</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_time</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">end_time</span><span class="p">):</span>
            <span class="c1"># first compute the value of all the constraints for each block</span>
            <span class="c1"># given the current starting time</span>
            <span class="n">block_transitions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">block_constraint_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                <span class="c1"># first figure out the transition</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">observing_blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">observing_blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">block_transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
                <span class="n">transition_time</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span> <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">trans</span><span class="o">.</span><span class="n">duration</span>

                <span class="n">times</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">transition_time</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">_duration_offsets</span>

                <span class="c1"># make sure it isn&#39;t in a pre-filled slot</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">((</span><span class="n">current_time</span> <span class="o">&lt;</span> <span class="n">filled_times</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filled_times</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="ow">or</span>
                        <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">pre_filled</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">current_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)):</span>
                    <span class="n">block_constraint_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">constraint_res</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span><span class="p">:</span>
                        <span class="n">constraint_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">times</span><span class="p">))</span>
                    <span class="c1"># take the product over all the constraints *and* times</span>
                    <span class="n">block_constraint_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">constraint_res</span><span class="p">))</span>

            <span class="c1"># now identify the block that&#39;s the best</span>
            <span class="n">bestblock_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">block_constraint_results</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">block_constraint_results</span><span class="p">[</span><span class="n">bestblock_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="c1"># if even the best is unobservable, we need a gap</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If there&#39;s a best one that&#39;s observable, first get its transition</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">block_transitions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">bestblock_idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">trans</span><span class="o">.</span><span class="n">duration</span>

                <span class="c1"># now assign the block itself times and add it to the schedule</span>
                <span class="n">newb</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">bestblock_idx</span><span class="p">)</span>
                <span class="n">newb</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="n">newb</span><span class="o">.</span><span class="n">duration</span>
                <span class="n">newb</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="n">newb</span><span class="o">.</span><span class="n">constraints_value</span> <span class="o">=</span> <span class="n">block_constraint_results</span><span class="p">[</span><span class="n">bestblock_idx</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">newb</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">newb</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span></div></div>

<div class="viewcode-block" id="PriorityScheduler"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.PriorityScheduler">[docs]</a><span class="k">class</span> <span class="nc">PriorityScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A scheduler that optimizes a prioritized list.  That is, it</span>
<span class="sd">    finds the best time for each ObservingBlock, in order of priority.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PriorityScheduler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="PriorityScheduler._get_filled_indices"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.PriorityScheduler._get_filled_indices">[docs]</a>    <span class="k">def</span> <span class="nf">_get_filled_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
        <span class="n">is_open_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># close times that are already filled</span>
        <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">block</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_time</span><span class="p">]</span> <span class="k">for</span>
                               <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">scheduled_blocks</span> <span class="k">if</span>
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">)])</span>

        <span class="k">for</span> <span class="n">start_end</span> <span class="ow">in</span> <span class="n">pre_filled</span><span class="p">:</span>
            <span class="n">filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">start_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">start_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filled</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">is_open_time</span><span class="p">[</span><span class="n">filled</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_open_time</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">filled</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">is_open_time</span></div>

<div class="viewcode-block" id="PriorityScheduler._get_date"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.PriorityScheduler._get_date">[docs]</a>    <span class="k">def</span> <span class="nf">_get_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
        <span class="c1"># close times that are already filled</span>
        <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">block</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_time</span><span class="p">]</span> <span class="k">for</span>
                               <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">scheduled_blocks</span> <span class="k">if</span>
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">pre_filled</span></div>

<div class="viewcode-block" id="PriorityScheduler._make_schedule"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.PriorityScheduler._make_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">_make_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="c1"># Combine individual constraints with global constraints, and</span>
        <span class="c1"># retrieve priorities from each block to define scheduling order</span>

        <span class="n">_all_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_block_priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">))</span>

        <span class="c1"># make sure we don&#39;t schedule below the horizon</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>

            <span class="n">b</span><span class="o">.</span><span class="n">_duration_offsets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">])</span>
            <span class="n">_block_priorities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">priority</span>

            <span class="n">_all_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span>

        <span class="c1"># Define a master schedule</span>
        <span class="c1"># Generate grid of time slots, and a mask for previous observations</span>

        <span class="n">time_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">time_grid_from_range</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">end_time</span><span class="p">],</span>
                                     <span class="n">time_resolution</span><span class="o">=</span><span class="n">time_resolution</span><span class="p">)</span>

        <span class="c1"># generate the score arrays for all of the blocks</span>
        <span class="n">scorer</span> <span class="o">=</span> <span class="n">Scorer</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span>
                        <span class="n">global_constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">score_array</span> <span class="o">=</span> <span class="n">scorer</span><span class="o">.</span><span class="n">create_score_array</span><span class="p">(</span><span class="n">time_resolution</span><span class="p">)</span>

        <span class="c1"># Sort the list of blocks by priority</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">_block_priorities</span><span class="p">)</span>

        <span class="n">unscheduled_blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">is_open_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filled_indices</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="c1">#index where not occupied</span>


        <span class="c1"># Compute the optimal observation time in priority order</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indices</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Compute possible observing times by combining object constraints</span>
            <span class="c1"># with the master open times mask</span>
            <span class="n">constraint_scores</span> <span class="o">=</span> <span class="n">score_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>


            <span class="c1"># Add up the applied constraints to prioritize the best blocks</span>
            <span class="c1"># And then remove any times that are already scheduled</span>
            <span class="n">is_open_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filled_indices</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>


            <span class="n">constraint_scores</span><span class="p">[</span><span class="o">~</span><span class="n">is_open_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">constraint_scores</span><span class="p">[</span><span class="n">is_open_time</span><span class="p">]</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">is_open_time</span><span class="p">)</span>

            <span class="c1"># Select the most optimal time</span>

            <span class="c1"># calculate the number of time slots needed for this exposure</span>
            <span class="n">_stride_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)))</span>

            <span class="c1"># Stride the score arrays by that number</span>
            <span class="n">_strided_scores</span> <span class="o">=</span> <span class="n">stride_array</span><span class="p">(</span><span class="n">constraint_scores</span><span class="p">,</span> <span class="n">_stride_by</span><span class="p">)</span>


            <span class="c1"># Collapse the sub-arrays</span>
            <span class="c1"># (run them through scorekeeper again? Just add them?</span>
            <span class="c1"># If there&#39;s a zero anywhere in there, def. have to skip)</span>
            <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_strided_scores</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sum_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_strided_scores</span><span class="p">))</span>
            <span class="n">sum_scores</span><span class="p">[</span><span class="n">good</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_strided_scores</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>



            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">constraint_scores</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">good</span><span class="p">):</span>
                <span class="c1"># No further calculation if no times meet the constraints</span>
                <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># schedulable in principle, provided the transition</span>
                <span class="c1"># does not prevent us from fitting it in.</span>
                <span class="c1"># loop over valid times and see if it fits</span>
                <span class="c1"># TODO: speed up by searching multiples of time resolution?</span>
                <span class="c1">#print(&#39;scores ordonnés&#39;,np.argsort(sum_scores))</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sum_scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">sum_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="c1"># we&#39;ve run through all optimal blocks</span>
                        <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">start_time_idx</span> <span class="o">=</span> <span class="n">idx</span>
                        <span class="n">new_start_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">start_time_idx</span><span class="p">]</span>
                        <span class="c1"># attempt to schedule block</span>
                        <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attempt_insert_block</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">new_start_time</span><span class="p">,</span> <span class="n">start_time_idx</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">_is_scheduled</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="c1"># idx can extend past end of _strided_open_time</span>
                        <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_scheduled</span><span class="p">:</span>
                <span class="n">unscheduled_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span></div>

<div class="viewcode-block" id="PriorityScheduler.attempt_insert_block"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.PriorityScheduler.attempt_insert_block">[docs]</a>    <span class="k">def</span> <span class="nf">attempt_insert_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">new_start_time</span><span class="p">,</span> <span class="n">start_time_idx</span><span class="p">):</span>
        <span class="c1"># set duration to be exact multiple of time resolution</span>
        <span class="n">duration_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)))</span>
        <span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration_indices</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span>

        <span class="c1"># add 1 second to the start time to allow for scheduling at the start of a slot</span>
        <span class="n">slot_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">new_start_time</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span> <span class="o">&lt;</span> <span class="n">slot</span><span class="o">.</span><span class="n">end</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slots_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[:</span><span class="n">slot_index</span><span class="p">]</span>
        <span class="n">slots_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># now check if there&#39;s a transition block where we want to go</span>
        <span class="c1"># if so, we delete it. A new one will be added if needed</span>
        <span class="n">delete_this_block_first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;block already occupied&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delete_this_block_first</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># no slots yet, so we should be fine to just shove this in</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">slots_before</span> <span class="ow">or</span> <span class="n">slots_after</span><span class="p">):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span> <span class="o">+</span> <span class="n">duration_indices</span>
            <span class="n">b</span><span class="o">.</span><span class="n">start_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">new_start_time</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="c1"># this shouldn&#39;t ever happen</span>
                <span class="c1"># print(&#39;Failed to insert {} into schedule.\n{}&#39;.format(</span>
                <span class="c1">#         b.target.name, str(error)</span>
                <span class="c1">#       ))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Other slots exist, so now we have to see if it will fit</span>
        <span class="c1"># if slots before or after, we need `TransitionBlock`s</span>
        <span class="n">tb_before</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tb_before_already_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tb_after</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">slots_before</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
                <span class="c1"># make a transitionblock</span>
                <span class="n">tb_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">TransitionBlock</span><span class="p">):</span>
                <span class="n">tb_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>
                <span class="n">tb_before_already_exists</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">slots_after</span><span class="p">:</span>
            <span class="n">slot_offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">delete_this_block_first</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="n">slot_offset</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
                <span class="c1"># make a transition object after the new ObservingBlock</span>
                <span class="n">tb_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                    <span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="n">slot_offset</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span>
                    <span class="n">new_start_time</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>

        <span class="c1"># tweak durations to exact multiple of time resolution</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tb_before</span><span class="p">,</span> <span class="n">tb_after</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">))</span>
                <span class="p">)</span>

        <span class="c1"># if we want to shift the OBs to minimise gaps, here is</span>
        <span class="c1"># where we should do it.</span>
        <span class="c1"># Find the smallest shift (forward or backward) to close gap</span>
        <span class="c1"># Check against tolerances (constraints must still be met)</span>
        <span class="c1"># Shift if OK and update new_start_time and start_time_idx</span>

        <span class="c1"># Now let&#39;s see if the block and transition can fit in the schedule</span>
        <span class="k">if</span> <span class="n">slots_before</span><span class="p">:</span>
            <span class="c1"># we&#39;re OK if the index at the end of the updated transition</span>
            <span class="c1"># is less than or equal to `start_time_idx`</span>
            <span class="n">ob_offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">tb_before_already_exists</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">previous_ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="n">ob_offset</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tb_before</span><span class="p">:</span>
                <span class="n">transition_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">tb_before</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transition_indices</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">start_time_idx</span> <span class="o">&lt;</span> <span class="n">previous_ob</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">end_idx</span> <span class="o">+</span> <span class="n">transition_indices</span><span class="p">:</span>
                <span class="c1"># cannot schedule</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">slots_after</span><span class="p">:</span>
            <span class="c1"># we&#39;re OK if the index at end of OB (plus transition)</span>
            <span class="c1"># is smaller than the start_index of the slot after</span>
            <span class="n">slot_offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">delete_this_block_first</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">next_ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="n">slot_offset</span><span class="p">]</span><span class="o">.</span><span class="n">block</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span> <span class="o">+</span> <span class="n">duration_indices</span>
            <span class="k">if</span> <span class="n">tb_after</span><span class="p">:</span>
                <span class="n">end_idx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">tb_after</span><span class="o">.</span><span class="n">duration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">end_idx</span> <span class="o">&gt;=</span> <span class="n">next_ob</span><span class="o">.</span><span class="n">start_idx</span><span class="p">:</span>
                    <span class="c1"># cannot schedule</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># OK, we should be OK to schedule now!</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># delete this block if it&#39;s a TransitionBlock</span>
            <span class="k">if</span> <span class="n">delete_this_block_first</span><span class="p">:</span>
                <span class="n">slot_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">change_slot_block</span><span class="p">(</span><span class="n">slot_index</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tb_before</span> <span class="ow">and</span> <span class="n">tb_before_already_exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">change_slot_block</span><span class="p">(</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="n">tb_before</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tb_before</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">tb_before</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">tb_before</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tb_before_already_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tb_before</span><span class="p">:</span>
                <span class="c1"># we already have a TB here, but we no longer need it!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">change_slot_block</span><span class="p">(</span><span class="n">slot_index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">b</span><span class="o">.</span><span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span> <span class="o">+</span> <span class="n">duration_indices</span>
            <span class="n">b</span><span class="o">.</span><span class="n">start_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">new_start_time</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tb_after</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">tb_after</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">tb_after</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="c1"># this shouldn&#39;t ever happen</span>
            <span class="c1"># print(&#39;Failed to insert {} (dur: {}) into schedule.\n{}\n{}&#39;.format(</span>
            <span class="c1">#        b.target.name, b.duration, new_start_time.iso, str(error)</span>
            <span class="c1">#       ))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div></div>

<span class="k">class</span> <span class="nc">SPECULOOSScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SPECULOOSScheduler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_filled_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
        <span class="n">is_open_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># close times that are already filled</span>
        <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">block</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_time</span><span class="p">]</span> <span class="k">for</span>
                               <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">scheduled_blocks</span> <span class="k">if</span>
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">)])</span>

        <span class="k">for</span> <span class="n">start_end</span> <span class="ow">in</span> <span class="n">pre_filled</span><span class="p">:</span>
            <span class="n">filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">start_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">start_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filled</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">is_open_time</span><span class="p">[</span><span class="n">filled</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_open_time</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">filled</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">is_open_time</span>

    <span class="k">def</span> <span class="nf">_get_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
        <span class="c1"># close times that are already filled</span>
        <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">block</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_time</span><span class="p">]</span> <span class="k">for</span>
                               <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">scheduled_blocks</span> <span class="k">if</span>
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">pre_filled</span>

    <span class="k">def</span> <span class="nf">_make_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="c1"># Combine individual constraints with global constraints, and</span>
        <span class="c1"># retrieve priorities from each block to define scheduling order</span>

        <span class="n">_all_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_block_priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">))</span>

        <span class="c1"># make sure we don&#39;t schedule below the horizon</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">_duration_offsets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">])</span>
            <span class="n">_block_priorities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">priority</span><span class="c1">#*(b.duration.value/((self.schedule.end_time.jd-self.schedule.start_time.jd)/0.041667))</span>

            <span class="n">_all_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span>

        <span class="c1"># Define a master schedule</span>
        <span class="c1"># Generate grid of time slots, and a mask for previous observations</span>

        <span class="n">time_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">time_grid_from_range</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">end_time</span><span class="p">],</span>
                                     <span class="n">time_resolution</span><span class="o">=</span><span class="n">time_resolution</span><span class="p">)</span>

        <span class="c1"># generate the score arrays for all of the blocks</span>
        
        <span class="n">scorer</span> <span class="o">=</span> <span class="n">Scorer</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span>
                        <span class="n">global_constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">score_array</span> <span class="o">=</span> <span class="n">scorer</span><span class="o">.</span><span class="n">create_score_array</span><span class="p">(</span><span class="n">time_resolution</span><span class="p">)</span>

        <span class="c1"># Sort the list of blocks by priority</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">_block_priorities</span><span class="p">)</span>

        <span class="n">unscheduled_blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">is_open_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filled_indices</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="c1">#index where not occupied, numpy array</span>


        <span class="c1"># Compute the optimal observation time in priority order</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indices</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Compute possible observing times by combining object constraints</span>
            <span class="c1"># with the master open times mask</span>

            <span class="n">constraint_scores</span> <span class="o">=</span> <span class="n">score_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">()</span>


            <span class="c1"># Add up the applied constraints to prioritize the best blocks</span>
            <span class="c1"># And then remove any times that are already scheduled</span>
            <span class="n">is_open_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filled_indices</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

            <span class="n">constraint_scores</span><span class="p">[</span><span class="o">~</span><span class="n">is_open_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Select the most optimal time</span>

            <span class="c1"># calculate the number of time slots needed for this exposure</span>

            <span class="n">_stride_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)))</span> <span class="c1"># number of slots in the block&#39;s duration, int</span>


            <span class="c1"># Stride the score arrays by that number</span>
            <span class="n">_strided_scores</span> <span class="o">=</span> <span class="n">stride_array</span><span class="p">(</span><span class="n">constraint_scores</span><span class="p">,</span> <span class="n">_stride_by</span><span class="p">)</span> <span class="c1">#Computes all possible sequential subarrays of arr with length = window_width</span>

            <span class="c1"># Collapse the sub-arrays</span>
            <span class="c1"># (run them through scorekeeper again? Just add them?</span>
            <span class="c1"># If there&#39;s a zero anywhere in there, def. have to skip)</span>
            <span class="c1">#print(np.where(_strided_scores[2] &gt; 0))</span>
            <span class="c1">#print(np.all(_strided_scores &gt; 1e-5, axis=1)) #good = np.all(_strided_scores &gt; 1e-5, axis=1)</span>
            <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_strided_scores</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="c1">#np.where(_strided_scores[2] &gt; 0)#np.all(_strided_scores &gt; 1e-5, axis=1)#np.where(_strided_scores &gt; 0)[0]</span>
            <span class="c1">#print(good)</span>
            <span class="n">sum_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_strided_scores</span><span class="p">))</span>
            <span class="n">sum_scores</span><span class="p">[</span><span class="n">good</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_strided_scores</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>



            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">constraint_scores</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
                <span class="c1"># No further calculation if no times meet the constraints</span>
                <span class="c1"># print(b,&#39;pb constraints&#39;)</span>
                <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># schedulable in principle, provided the transition</span>
                <span class="c1"># does not prevent us from fitting it in.</span>
                <span class="c1"># loop over valid times and see if it fits</span>
                <span class="c1"># TODO: speed up by searching multiples of time resolution?</span>
                <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sum_scores</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">start_time_idx</span> <span class="o">=</span> <span class="n">idx</span>

                <span class="n">new_start_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">start_time_idx</span><span class="p">]</span>

                <span class="c1"># attempt to schedule block</span>
                <span class="c1">#_is_scheduled = self.attempt_insert_block(b, new_start_time, start_time_idx)</span>
                <span class="n">b</span><span class="o">.</span><span class="n">duration_old</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span>

                <span class="k">while</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">_is_scheduled</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">duration_old</span><span class="o">-</span><span class="mf">0.01</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span>
                    <span class="n">is_open_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filled_indices</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

                    <span class="n">constraint_scores</span><span class="p">[</span><span class="o">~</span><span class="n">is_open_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">_stride_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)))</span>
                    <span class="n">_strided_scores</span> <span class="o">=</span> <span class="n">stride_array</span><span class="p">(</span><span class="n">constraint_scores</span><span class="p">,</span> <span class="n">_stride_by</span><span class="p">)</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_strided_scores</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="c1">#np.where(_strided_scores[2] &gt; 0)#np.where(_strided_scores &gt; 0)[0]</span>
                    <span class="n">sum_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_strided_scores</span><span class="p">))</span>
                    <span class="n">sum_scores</span><span class="p">[</span><span class="n">good</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_strided_scores</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">):</span>
                        <span class="n">sum_scores</span><span class="p">[</span><span class="n">good</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sum_scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">sum_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.0E-5</span><span class="p">:</span>
                            <span class="c1"># we&#39;ve run through all optimal blocks</span>
                            <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start_time_idx</span> <span class="o">=</span> <span class="n">idx</span>
                            <span class="n">new_start_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">start_time_idx</span><span class="p">]</span>
                            <span class="c1"># attempt to schedule block</span>
                            <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attempt_insert_block</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">new_start_time</span><span class="p">,</span> <span class="n">start_time_idx</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">_is_scheduled</span><span class="p">:</span>
                                <span class="k">break</span>

                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="c1"># print(&#39;indexerror&#39;)</span>
                            <span class="c1"># idx can extend past end of _strided_open_time</span>
                            <span class="n">_is_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">duration_old</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span>


            <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_scheduled</span><span class="p">:</span>
                <span class="n">unscheduled_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">empty_space</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_filled_indices</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_space</span><span class="p">)</span><span class="o">*</span><span class="n">time_resolution</span><span class="o">.</span><span class="n">value</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trop de blanc&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span>

    <span class="k">def</span> <span class="nf">attempt_insert_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">new_start_time</span><span class="p">,</span> <span class="n">start_time_idx</span><span class="p">):</span>
        <span class="c1"># set duration to be exact multiple of time resolution</span>
        <span class="n">duration_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)))</span>
        <span class="n">b</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration_indices</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span>

        <span class="c1"># add 1 second to the start time to allow for scheduling at the start of a slot</span>
        <span class="n">slot_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">new_start_time</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span> <span class="o">&lt;</span> <span class="n">slot</span><span class="o">.</span><span class="n">end</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slots_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[:</span><span class="n">slot_index</span><span class="p">]</span>
        <span class="n">slots_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># now check if there&#39;s a transition block where we want to go</span>
        <span class="c1"># if so, we delete it. A new one will be added if needed</span>
        <span class="n">delete_this_block_first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
                <span class="c1"># raise ValueError(&#39;block already occupied&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delete_this_block_first</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># no slots yet, so we should be fine to just shove this in</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">slots_before</span> <span class="ow">or</span> <span class="n">slots_after</span><span class="p">):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span> <span class="o">+</span> <span class="n">duration_indices</span>
            <span class="n">b</span><span class="o">.</span><span class="n">start_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">new_start_time</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="c1"># this shouldn&#39;t ever happen</span>

                <span class="c1"># print(&#39;Failed to insert {} into schedule.\n{}&#39;.format(</span>
                <span class="c1">#         b.target.name, str(error)</span>
                <span class="c1">#       ))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Other slots exist, so now we have to see if it will fit</span>
        <span class="c1"># if slots before or after, we need `TransitionBlock`s</span>
        <span class="n">tb_before</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tb_before_already_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tb_after</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">slots_before</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
                <span class="c1"># make a transitionblock</span>
                <span class="n">tb_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">TransitionBlock</span><span class="p">):</span>
                <span class="n">tb_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>
                <span class="n">tb_before_already_exists</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">slots_after</span><span class="p">:</span>
            <span class="n">slot_offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">delete_this_block_first</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="n">slot_offset</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">):</span>
                <span class="c1"># make a transition object after the new ObservingBlock</span>
                <span class="n">tb_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span>
                    <span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="n">slot_offset</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">,</span>
                    <span class="n">new_start_time</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>

        <span class="c1"># tweak durations to exact multiple of time resolution</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tb_before</span><span class="p">,</span> <span class="n">tb_after</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">))</span>
                <span class="p">)</span>

        <span class="c1"># if we want to shift the OBs to minimise gaps, here is</span>
        <span class="c1"># where we should do it.</span>
        <span class="c1"># Find the smallest shift (forward or backward) to close gap</span>
        <span class="c1"># Check against tolerances (constraints must still be met)</span>
        <span class="c1"># Shift if OK and update new_start_time and start_time_idx</span>

        <span class="c1"># Now let&#39;s see if the block and transition can fit in the schedule</span>
        <span class="k">if</span> <span class="n">slots_before</span><span class="p">:</span>
            <span class="c1"># we&#39;re OK if the index at the end of the updated transition</span>
            <span class="c1"># is less than or equal to `start_time_idx`</span>
            <span class="n">ob_offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">tb_before_already_exists</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">previous_ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">-</span> <span class="n">ob_offset</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tb_before</span><span class="p">:</span>
                <span class="n">transition_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">tb_before</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transition_indices</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">start_time_idx</span> <span class="o">&lt;</span> <span class="n">previous_ob</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">end_idx</span> <span class="o">+</span> <span class="n">transition_indices</span><span class="p">:</span>
                <span class="c1"># cannot schedule</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">slots_after</span><span class="p">:</span>
            <span class="c1"># we&#39;re OK if the index at end of OB (plus transition)</span>
            <span class="c1"># is smaller than the start_index of the slot after</span>
            <span class="n">slot_offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">delete_this_block_first</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">next_ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_index</span> <span class="o">+</span> <span class="n">slot_offset</span><span class="p">]</span><span class="o">.</span><span class="n">block</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span> <span class="o">+</span> <span class="n">duration_indices</span>
            <span class="k">if</span> <span class="n">tb_after</span><span class="p">:</span>
                <span class="n">end_idx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">tb_after</span><span class="o">.</span><span class="n">duration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">end_idx</span> <span class="o">&gt;=</span> <span class="n">next_ob</span><span class="o">.</span><span class="n">start_idx</span><span class="p">:</span>
                    <span class="c1"># cannot schedule</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># OK, we should be OK to schedule now!</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># delete this block if it&#39;s a TransitionBlock</span>
            <span class="k">if</span> <span class="n">delete_this_block_first</span><span class="p">:</span>
                <span class="n">slot_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">change_slot_block</span><span class="p">(</span><span class="n">slot_index</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tb_before</span> <span class="ow">and</span> <span class="n">tb_before_already_exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">change_slot_block</span><span class="p">(</span><span class="n">slot_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="n">tb_before</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tb_before</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">tb_before</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">tb_before</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tb_before_already_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tb_before</span><span class="p">:</span>
                <span class="c1"># we already have a TB here, but we no longer need it!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">change_slot_block</span><span class="p">(</span><span class="n">slot_index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_block</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">b</span><span class="o">.</span><span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span> <span class="o">+</span> <span class="n">duration_indices</span>
            <span class="n">b</span><span class="o">.</span><span class="n">start_idx</span> <span class="o">=</span> <span class="n">start_time_idx</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">new_start_time</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tb_after</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">tb_after</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">tb_after</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="c1"># this shouldn&#39;t ever happen</span>
            <span class="c1"># print(&#39;Failed to insert {} (dur: {}) into schedule.\n{}\n{}&#39;.format(</span>
            <span class="c1">#        b.target.name, b.duration, new_start_time.iso, str(error)</span>
            <span class="c1">#       ))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Transitioner"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Transitioner">[docs]</a><span class="k">class</span> <span class="nc">Transitioner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that defines how to compute transition times from one block to</span>
<span class="sd">    another.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="o">.</span><span class="n">quantity_input</span><span class="p">(</span><span class="n">slew_rate</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slew_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instrument_reconfig_times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        slew_rate : `~astropy.units.Quantity` with angle/time units</span>
<span class="sd">            The slew rate of the telescope</span>
<span class="sd">        instrument_reconfig_times : dict of dicts or None</span>
<span class="sd">            If not None, gives a mapping from property names to another</span>
<span class="sd">            dictionary. The second dictionary maps 2-tuples of states to the</span>
<span class="sd">            time it takes to transition between those states (as an</span>
<span class="sd">            `~astropy.units.Quantity`), can also take a &#39;default&#39; key</span>
<span class="sd">            mapped to a default transition time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slew_rate</span> <span class="o">=</span> <span class="n">slew_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument_reconfig_times</span> <span class="o">=</span> <span class="n">instrument_reconfig_times</span>

<div class="viewcode-block" id="Transitioner.__call__"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Transitioner.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldblock</span><span class="p">,</span> <span class="n">newblock</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">observer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the amount of time needed to transition from one observing</span>
<span class="sd">        block to another.  This uses the parameters defined in</span>
<span class="sd">        ``self.instrument_reconfig_times``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        oldblock : `~astroplan.scheduling.ObservingBlock` or None</span>
<span class="sd">            The initial configuration/target</span>
<span class="sd">        newblock : `~astroplan.scheduling.ObservingBlock` or None</span>
<span class="sd">            The new configuration/target to transition to</span>
<span class="sd">        start_time : `~astropy.time.Time`</span>
<span class="sd">            The time the transition should start</span>
<span class="sd">        observer : `astroplan.Observer`</span>
<span class="sd">            The observer at the time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transition : `~astroplan.scheduling.TransitionBlock` or None</span>
<span class="sd">            A transition to get from ``oldblock`` to ``newblock`` or `None` if</span>
<span class="sd">            no transition is necessary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slew_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">oldblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">newblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="c1"># use the constraints cache for now, but should move that machinery</span>
            <span class="c1"># to observer</span>
            <span class="kn">from</span> <span class="nn">astroplan.constraints</span> <span class="kn">import</span> <span class="n">_get_altaz</span>
            <span class="kn">from</span> <span class="nn">astroplan.target</span> <span class="kn">import</span> <span class="n">get_skycoord</span>
            <span class="k">if</span> <span class="n">oldblock</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="n">newblock</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">astroplan.target</span> <span class="kn">import</span> <span class="n">get_skycoord</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">get_skycoord</span><span class="p">([</span><span class="n">oldblock</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">newblock</span><span class="o">.</span><span class="n">target</span><span class="p">])</span>
                <span class="n">aaz</span> <span class="o">=</span> <span class="n">_get_altaz</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">targets</span><span class="p">)[</span><span class="s1">&#39;altaz&#39;</span><span class="p">]</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">aaz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">aaz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">slew_rate</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
                    <span class="n">components</span><span class="p">[</span><span class="s1">&#39;slew_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">slew_rate</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument_reconfig_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">components</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_instrument_transitions</span><span class="p">(</span><span class="n">oldblock</span><span class="p">,</span> <span class="n">newblock</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TransitionBlock</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Transitioner.compute_instrument_transitions"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.Transitioner.compute_instrument_transitions">[docs]</a>    <span class="k">def</span> <span class="nf">compute_instrument_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldblock</span><span class="p">,</span> <span class="n">newblock</span><span class="p">):</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">conf_name</span><span class="p">,</span> <span class="n">old_conf</span> <span class="ow">in</span> <span class="n">oldblock</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">conf_name</span> <span class="ow">in</span> <span class="n">newblock</span><span class="o">.</span><span class="n">configuration</span><span class="p">:</span>
                <span class="n">conf_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument_reconfig_times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">conf_name</span><span class="p">,</span>
                                                                <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conf_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_conf</span> <span class="o">=</span> <span class="n">newblock</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="n">conf_name</span><span class="p">]</span>
                    <span class="n">ctime</span> <span class="o">=</span> <span class="n">conf_times</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">old_conf</span><span class="p">,</span> <span class="n">new_conf</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">def_time</span> <span class="o">=</span> <span class="n">conf_times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ctime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1"> to </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_name</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">,</span>
                                                    <span class="n">new_conf</span><span class="p">)</span>
                        <span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctime</span>
                    <span class="k">elif</span> <span class="n">def_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">old_conf</span> <span class="o">==</span> <span class="n">new_conf</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1"> to </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_name</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">,</span>
                                                    <span class="n">new_conf</span><span class="p">)</span>
                        <span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">def_time</span>

        <span class="k">return</span> <span class="n">components</span></div></div>


<div class="viewcode-block" id="DateElsa"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.DateElsa">[docs]</a><span class="k">class</span> <span class="nc">DateElsa</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the start and end of a block chosen.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DateElsa</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="DateElsa.start_and_end"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.DateElsa.start_and_end">[docs]</a>    <span class="k">def</span> <span class="nf">start_and_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
        <span class="c1"># close times that are already filled</span>
        <span class="n">pre_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">block</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_time</span><span class="p">]</span> <span class="k">for</span>
                               <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">scheduled_blocks</span> <span class="k">if</span>
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ObservingBlock</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">pre_filled</span></div></div>


<div class="viewcode-block" id="SimpleScheduler"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.SimpleScheduler">[docs]</a><span class="k">class</span> <span class="nc">SimpleScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    schedule blocks randomly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleScheduler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleScheduler._make_schedule"><a class="viewcode-back" href="../autoapi/spe_schedule/index.html#spe_schedule.SimpleScheduler._make_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">_make_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
        <span class="c1"># gather all the constraints on each block into a single attribute</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span>

            <span class="c1"># to make sure the Scorer has some constraint to work off of</span>
            <span class="c1"># and to prevent scheduling of targets below the horizon</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
                <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">AltitudeConstraint</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span><span class="p">):</span>
                <span class="n">b</span><span class="o">.</span><span class="n">_all_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AltitudeConstraint</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">b</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span>

        <span class="c1"># before we can schedule, we need to know where blocks meet the constraints</span>
        <span class="n">scorer</span> <span class="o">=</span> <span class="n">Scorer</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span>
                        <span class="n">global_constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">score_array</span> <span class="o">=</span> <span class="n">scorer</span><span class="o">.</span><span class="n">create_score_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
        <span class="c1"># now we have an array of the scores for the blocks at intervals of</span>
        <span class="c1"># ``time_resolution``. The scores range from zero to one, some blocks may have</span>
        <span class="c1"># higher scores than others, but we only care if they are greater than zero</span>

        <span class="c1"># we want to start from the beginning and start scheduling</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="k">while</span> <span class="n">current_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
            <span class="n">scheduled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="ow">and</span> <span class="n">scheduled</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># the schedule starts with only 1 slot</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">test_time</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="c1"># when a block is inserted, the number of slots increases</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># a test transition between the last scheduled block and this one</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitioner</span><span class="p">(</span><span class="n">schedule</span><span class="o">.</span><span class="n">observing_blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">block</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">)</span>
                    <span class="n">test_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">transition</span><span class="o">.</span><span class="n">duration</span>
                <span class="c1"># how many time intervals are we from the start</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">test_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
                <span class="n">duration_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">duration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>
                <span class="c1"># if any score during the block&#39;s duration would be 0, reject it</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">score_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">start_idx</span><span class="o">+</span><span class="n">duration_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="c1"># if all of the scores are &gt;0, accept and schedule it</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">slots</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">insert_slot</span><span class="p">(</span><span class="n">test_time</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
                    <span class="c1"># advance the time and remove the block from the list</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">test_time</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">duration</span>
                    <span class="n">scheduled</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">blocks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="c1"># if every block failed, progress the time</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_time</span>
        <span class="k">return</span> <span class="n">schedule</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Elsa Ducrot

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>